# ğŸ¤– æœ‰é™çŠ¶æ€æœº (FSM) è®¾è®¡ä¸å®æˆ˜æŒ‡å—

**æ–‡æ¡£ç›®æ ‡ï¼š** è¯¦è§£ Vampirefall ä¸­ AI è¡Œä¸ºçš„æ ¸å¿ƒé©±åŠ¨é€»è¾‘ã€‚
**é€‚ç”¨å¯¹è±¡ï¼š** æ€ªç‰© AIã€é˜²å¾¡å¡”é€»è¾‘ã€Boss é˜¶æ®µè½¬æ¢ã€‚

---

## 1. ğŸ§  FSM æ ¸å¿ƒæ¦‚å¿µ (The Basics)

æœ‰é™çŠ¶æ€æœºç”±ä¸‰ä¸ªè¦ç´ ç»„æˆï¼š
1.  **çŠ¶æ€ (State):** è§’è‰²å½“å‰åœ¨åšä»€ä¹ˆï¼Ÿ (e.g., `Idle`, `Chase`, `Attack`)
2.  **è½¬æ¢ (Transition):** ä»€ä¹ˆæ¡ä»¶ä¸‹åˆ‡æ¢åˆ°å¦ä¸€ä¸ªçŠ¶æ€ï¼Ÿ (e.g., `Distance < 5m` -> åˆ‡æ¢åˆ° `Attack`)
3.  **è¡Œä¸º (Action):** è¿›å…¥/é€€å‡º/ä¿æŒè¯¥çŠ¶æ€æ—¶åšä»€ä¹ˆï¼Ÿ (e.g., `OnEnter`: æ’­æ”¾å¼å«åŠ¨ç”»)

---

## 2. ğŸ‘¹ æ€ªç‰© AI çŠ¶æ€æœº (Monster FSM)

æ··åˆå“ç±»æ¸¸æˆçš„æ€ªç‰© AI æ¯”ä¼ ç»Ÿå¡”é˜²æ›´å¤æ‚ï¼Œå› ä¸ºå®ƒéœ€è¦å¤„ç†â€œä»‡æ¨åˆ‡æ¢â€ã€‚

### 2.1 çŠ¶æ€æµè½¬å›¾ (State Graph)

```mermaid
graph TD
    Spawn(å‡ºç”Ÿ) -->|è½åœ°åŠ¨ç”»ç»“æŸ| Move(å¯»è·¯ç§»åŠ¨)
    Move -->|é‡åˆ°è·¯éšœ| Breach(æ‹†å¢™/å¡”)
    Move -->|è¢«ç©å®¶æ”»å‡»/å˜²è®½| Aggro(ä»‡æ¨è¿½å‡»)
    Aggro -->|è·ç¦»è¿‡è¿œ/è¶…æ—¶| Move
    Aggro -->|è¿›å…¥æ”»å‡»èŒƒå›´| Attack(æ”»å‡»)
    Breach -->|å¡”è¢«æ‘§æ¯| Move
    Attack -->|ç›®æ ‡æ­»äº¡| Move
    Attack -->|æ”»å‡»åæ‘‡ç»“æŸ| Cooldown(å¯¹å³™/è°ƒæ•´)
    Cooldown -->|CDç»“æŸ| Attack
```

### 2.2 å…³é”®çŠ¶æ€è¯¦è§£

#### A. `State_Move` (å¯»è·¯ç§»åŠ¨)
*   **ç›®æ ‡ï¼š** æ²¿ç€ FlowField (æµåœº) æˆ– NavMesh èµ°å‘åŸºåœ°ã€‚
*   **ç‰¹æ®Šé€»è¾‘ï¼š** **æ— è§†ç©å®¶**ã€‚è¿™æ˜¯å¡”é˜²æ€ªç‰©çš„ç‰¹å¾ï¼Œå®ƒä»¬çœ¼é‡Œåªæœ‰åŸºåœ°ã€‚é™¤éè¢«â€œå˜²è®½â€æˆ–å—åˆ°é«˜é¢ä¼¤å®³ã€‚
*   **ä»£ç é€»è¾‘ï¼š** æ¯ 0.5ç§’ æ£€æµ‹ä¸€æ¬¡å‰æ–¹æ˜¯å¦æœ‰ `Obstacle` (å¡”/å¢™)ã€‚å¦‚æœæœ‰ï¼Œåˆ‡æ¢åˆ° `State_Breach`ã€‚

#### B. `State_Breach` (æ‹†å¢™)
*   **åœºæ™¯ï¼š** æ€ªç‰©è¢«å¡”æŒ¡ä½äº†å»è·¯ï¼Œæˆ–è€…è¿™æ˜¯ä¸ªä¸“é—¨æ‹†å¡”çš„â€œå·¥å…µæ€ªâ€ã€‚
*   **é€»è¾‘ï¼š** é”å®šé¢å‰çš„å¡”ï¼Œæ’­æ”¾æ”»å‡»åŠ¨ç”»ã€‚
*   **é€€å‡ºæ¡ä»¶ï¼š**
    1.  å¡”ç‚¸äº† -> åˆ‡å› `Move`ã€‚
    2.  ç©å®¶è¿‡æ¥æ‰“äº†å®ƒä¸€ä¸‹ -> åˆ‡åˆ° `Aggro`ã€‚

#### C. `State_Aggro` (ä»‡æ¨/è¿½å‡»)
*   **åœºæ™¯ï¼š** ARPG å…ƒç´ çš„æ ¸å¿ƒã€‚
*   **é€»è¾‘ï¼š** æš‚æ—¶æ”¾å¼ƒåŸºåœ°ï¼Œè¿½ç€ç©å®¶ï¼ˆæˆ–å˜²è®½å›¾è…¾ï¼‰æ‰“ã€‚
*   **Leash (ç‹—é“¾) æœºåˆ¶ï¼š** ä¸ºäº†é˜²æ­¢ç©å®¶æŠŠæ€ªé£ç­åˆ°åœ°å›¾è¾¹ç¼˜ï¼Œå¿…é¡»è®¾ç½®ä¸€ä¸ª `MaxAggroDistance` (æ¯”å¦‚ 15ç±³) æˆ– `MaxAggroTime` (æ¯”å¦‚ 5ç§’)ã€‚è¶…è¿‡é™åˆ¶å¼ºåˆ¶åˆ‡å› `Move`ï¼Œå¹¶ä¸” 3ç§’å†…å…ç–«ä»‡æ¨ã€‚

### 2.3 ğŸ“ æ™®é€šæ€ªç‰©å®æˆ˜æ¡ˆä¾‹ (Minion Examples)

ç»“åˆæ¸¸æˆç‰¹è‰²ï¼Œæˆ‘ä»¬å®šä¹‰ä¸¤ç§æç«¯çš„æ€ªç‰© AI æ¨¡æ¿ã€‚

#### æ¡ˆä¾‹ A: éª·é«…å·¥å…µ (Skeleton Sapper) - *ç»å¯¹æ”»åŸå‹*
*   **å®šä½:** ç©å®¶çš„å™©æ¢¦ï¼Œå¿…é¡»ä¼˜å…ˆå¤„ç†ã€‚
*   **FSM ç‰¹å¼‚ç‚¹:**
    *   **æ—  Aggro çŠ¶æ€:** å®ƒçš„çŠ¶æ€æœºé‡Œ**åˆ é™¤äº†** `Aggro` çŠ¶æ€ã€‚
    *   **é€»è¾‘:** å³ä½¿ç©å®¶æ‹¿åˆ€ç å®ƒçš„å¤´ï¼Œå®ƒä¹Ÿç»å¯¹ä¸å›å¤´ï¼Œä¸€å¿ƒä¸€æ„å¾€åŸºåœ°èµ°ã€‚
    *   **è¢«åŠ¨:** å½“ `HP < 30%` æ—¶ï¼Œåˆ‡æ¢åˆ° `Sprint` (å†²åˆº) çŠ¶æ€ï¼Œç§»é€Ÿç¿»å€ã€‚

#### æ¡ˆä¾‹ B: å¹½çµåˆºå®¢ (Ghost Assassin) - *é£ç­/åˆ‡åæ’å‹*
*   **å®šä½:** éªšæ‰°ç©å®¶ï¼Œè¿«ä½¿ç©å®¶èµ°ä½ã€‚
*   **FSM ç‰¹å¼‚ç‚¹:**
    *   **æ–°å¢ `Flee` (é€ƒç¦») çŠ¶æ€:**
        *   å½“ `DistanceToPlayer < 3m` (è¢«è¿‘èº«) æ—¶ï¼Œè§¦å‘é€ƒç¦»ã€‚
        *   é€»è¾‘: å‘ `(SelfPos - PlayerPos)` æ–¹å‘ç§»åŠ¨ 2ç§’ã€‚
    *   **æ–°å¢ `Stealth` (éšèº«) çŠ¶æ€:**
        *   é€ƒç¦»ç»“æŸåï¼Œè¿›å…¥éšèº«ï¼ˆä¸å¯è¢«å¡”é”å®šï¼‰ï¼Œå°è¯•ç»•åã€‚

---

## 3. ğŸ‘‘ Boss æˆ˜æ–—çŠ¶æ€æœº (Boss FSM)

Boss ä¸ä»…ä»…æ˜¯è¡€åšçš„æ€ªï¼Œå®ƒæ˜¯ä¸€ä¸ª**å¸¦æœ‰å‰§æœ¬çš„æµç¨‹**ã€‚æˆ‘ä»¬éœ€è¦å¼•å…¥ **"Phase System" (é˜¶æ®µç³»ç»Ÿ)**ã€‚

### 3.1 é˜¶æ®µè½¬æ¢æµè½¬å›¾

Boss çš„ FSM æ˜¯åˆ†å±‚çš„ï¼šä¸Šå±‚ç®¡ç†é˜¶æ®µï¼Œä¸‹å±‚ç®¡ç†å…·ä½“è¡Œä¸ºã€‚

```mermaid
graph TD
    Intro(ç™»åœºæ¼”å‡º) --> Phase1
    Phase1 -->|HP < 60%| Transition1(è½¬é˜¶æ®µ/æ— æ•Œ)
    Transition1 --> Phase2
    Phase2 -->|HP < 20%| Transition2(ç‹‚æš´å‰æ‘‡)
    Transition2 --> Phase3(è½¯ç‹‚æš´/Rage)
    Phase3 --> Dead
```

### 3.2 å®æˆ˜æ¡ˆä¾‹ï¼šé²œè¡€é¢†ä¸» (Vampire Lord)

#### **Phase 1: ä¼˜é›…å‰‘æœ¯ (100% - 60% HP)**
*   **è¡Œä¸ºæ¨¡å¼:** ç±»ä¼¼äºå¼ºåŠ›ç²¾è‹±æ€ªã€‚
*   **çŠ¶æ€æ± :**
    *   `Slash`: å‰æ–¹æ‰‡å½¢æ–©å‡»ã€‚
    *   `Thrust`: é’ˆå¯¹ä»‡æ¨ç›®æ ‡çš„å¿«é€Ÿçªåˆºã€‚
    *   `SummonBats`: å¬å”¤ 2 åªå°è™è éªšæ‰°ã€‚
*   **è½¬æ¢æ¡ä»¶:** `HP < 60%` -> è§¦å‘ `State_Vanish` (æ¶ˆå¤±)ã€‚

#### **Transition 1: é²œè¡€ç››å®´ (æœºåˆ¶æ£€æµ‹)**
*   **è¡Œä¸º:**
    *   Boss å˜ä¸ºä¸å¯é€‰ä¸­ï¼Œç¬ç§»åˆ°å¤§å…ä¸­å¤®æ‚¬ç©ºã€‚
    *   åœºåœ°å››å‘¨ç”Ÿæˆ 4 ä¸ª **[è¡€èŒ§]**ã€‚
    *   è¡€èŒ§ä¼šç¼“æ…¢å‘ Boss ç§»åŠ¨ï¼Œå¦‚æœç¢°åˆ° Bossï¼Œæ¯åƒä¸€ä¸ªå›è¡€ 10%ã€‚
*   **ç©å®¶ç›®æ ‡:** åœ¨è¡€èŒ§ç¢°åˆ° Boss å‰æ‰“çˆ†å®ƒä»¬ã€‚
*   **ç»“æŸ:** æ‰€æœ‰è¡€èŒ§è¢«æ¯æˆ–è¢«åƒ -> è¿›å…¥ Phase 2ã€‚

#### **Phase 2: é­”æ³•è½°ç‚¸ (60% - 20% HP)**
*   **è¡Œä¸ºæ¨¡å¼:** ç«™æ¡©æ³•å¸ˆï¼Œé«˜é¢‘ AOEã€‚
*   **çŠ¶æ€æ± :**
    *   `BloodRain`: åœ°é¢éšæœºç”Ÿæˆçº¢åœˆï¼Œ2ç§’åçˆ†ç‚¸ã€‚
    *   `LaserSweep`: æ—‹è½¬æ¿€å…‰æ‰«å°„å…¨åœºï¼Œç©å®¶å¿…é¡»è·Ÿç€è½¬æˆ–ç”¨æ— æ•Œå¸§ç©¿è¿‡ã€‚
*   **è½¬æ¢æ¡ä»¶:** `HP < 20%` -> è§¦å‘ `State_Enrage` (å¼å«åŠ¨ç”»)ã€‚

#### **Phase 3: å›°å…½ä¹‹æ–— (20% - 0% HP)**
*   **è¡Œä¸ºæ¨¡å¼:** ç–¯ç‹—æ¨¡å¼ (DPS Check)ã€‚
*   **çŠ¶æ€:**
    *   ç§»é€Ÿ +100%ï¼Œæ”»é€Ÿ +50%ã€‚
    *   ä¸å†é‡Šæ”¾è¿œç¨‹æŠ€èƒ½ï¼Œå•çº¯åœ°è¿½ç€ç©å®¶å¹³ Aã€‚
    *   **è½¯ç‹‚æš´:** æ¯è¿‡ 10ç§’ï¼Œæ”»å‡»åŠ›å åŠ  10%ã€‚å¼ºè¿«ç©å®¶å°½å¿«å‡»æ€ã€‚

---

## 4. ğŸ—¼ é˜²å¾¡å¡”çŠ¶æ€æœº (Tower FSM)

å¡”çš„é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œé‡ç‚¹åœ¨äºâ€œç´¢æ•Œæ•ˆç‡â€å’Œâ€œçŠ¶æ€é‡ç½®â€ã€‚

### 3.1 çŠ¶æ€æµè½¬å›¾

```mermaid
graph TD
    Idle(å¾…æœºæ‰«æ) -->|å‘ç°æ•Œäºº| Warmup(é¢„çƒ­/ç„å‡†)
    Warmup -->|é¢„çƒ­å®Œæˆ| Fire(å¼€ç«)
    Fire -->|å¼€ç«ç»“æŸ| Cooldown(å†·å´/è£…å¡«)
    Cooldown -->|CDç»“æŸ & æœ‰æ•Œäºº| Fire
    Cooldown -->|CDç»“æŸ & æ— æ•Œäºº| Idle
    Fire -->|ç›®æ ‡æ­»äº¡/ä¸¢å¤±| Idle
```

### 3.2 å…³é”®çŠ¶æ€è¯¦è§£

#### A. `State_Idle` (å¾…æœºæ‰«æ)
*   **æ€§èƒ½ä¼˜åŒ–ï¼š** ä¸è¦æ¯å¸§ `Update` é‡Œéƒ½å» `Physics.OverlapSphere`ã€‚
*   **æœ€ä½³å®è·µï¼š** ä½¿ç”¨ **åç¨‹** æˆ– **Timer**ï¼Œæ¯ 0.1ç§’ - 0.2ç§’ æ‰«æä¸€æ¬¡ã€‚æˆ–è€…è®©æ€ªç‰©è¿›å…¥å°„ç¨‹æ—¶ä¸»åŠ¨è§¦å‘å¡”çš„ Triggerã€‚

#### B. `State_Warmup` (é¢„çƒ­/ç„å‡†)
*   **åœºæ™¯ï¼š** æ¿€å…‰å¡”éœ€è¦è“„åŠ›ï¼Œæˆ–è€…ç‚®å¡”éœ€è¦æ—‹è½¬ç‚®å£å¯¹å‡†ç›®æ ‡ã€‚
*   **é€»è¾‘ï¼š**
    *   `TurretHead.LookAt(Target)`ã€‚
    *   å¦‚æœæ˜¯æ¿€å…‰å¡”ï¼Œæ’­æ”¾â€œå—¡å—¡å—¡â€çš„éŸ³æ•ˆå’Œå…‰æ•ˆã€‚
    *   å¦‚æœç›®æ ‡è·‘å‡ºäº†å°„ç¨‹ï¼Œåˆ‡å› `Idle` (æµªè´¹äº†è“„åŠ›)ã€‚

#### C. `State_Fire` (å¼€ç«)
*   **é€»è¾‘ï¼š**
    *   ç”Ÿæˆå­å¼¹ (ä»å¯¹è±¡æ± )ã€‚
    *   æ’­æ”¾åååŠ›åŠ¨ç”»ã€‚
    *   **ç¬é—´åˆ‡å…¥** `State_Cooldown`ã€‚ä¸è¦åœç•™åœ¨ Fire çŠ¶æ€ã€‚

---

## 4. ğŸ’» ä»£ç å®æˆ˜ï¼šè½»é‡çº§ FSM æ¡†æ¶ (No-GC)

ä¸è¦ç”¨å¤æ‚çš„ç±»ç»§æ‰¿ (Class-based States) æ¥åšæˆåƒä¸Šä¸‡çš„å°æ€ªï¼Œé‚£æ ·å†…å­˜å¼€é”€å¤ªå¤§ã€‚
æ¨èä½¿ç”¨ **Enum + Switch** (ç®€å•æ€ª) æˆ– **Struct-based FSM** (å¤æ‚æ€ª)ã€‚

### 4.1 æ–¹æ¡ˆ A: æç®€ç‰ˆ (é€‚åˆå°æ€ª/å¡”)

```csharp
public enum EState { Idle, Move, Attack, Dead }

public class SimpleMonster : MonoBehaviour {
    private EState _currentState;
    private float _stateTimer;

    void Update() {
        // çŠ¶æ€æœºé©±åŠ¨
        switch (_currentState) {
            case EState.Move: UpdateMove(); break;
            case EState.Attack: UpdateAttack(); break;
        }
    }

    void ChangeState(EState newState) {
        OnExit(_currentState);
        _currentState = newState;
        _stateTimer = 0;
        OnEnter(newState);
    }
    
    // ... å…·ä½“é€»è¾‘å†™åœ¨å‡½æ•°é‡Œ
}
```

### 4.2 æ–¹æ¡ˆ B: ç»“æ„åŒ–ç‰ˆ (é€‚åˆ Boss/ç©å®¶)

å¦‚æœä½ å«Œ Switch å¤ªä¹±ï¼Œå¯ä»¥ç”¨è½»é‡çº§çš„ç±»å°è£…ï¼Œä½†è¦é¿å…æ¯å¸§ `new`ã€‚

```csharp
// 1. å®šä¹‰çŠ¶æ€åŸºç±»
public abstract class BaseState {
    protected BossController _boss;
    public BaseState(BossController boss) { _boss = boss; }
    public abstract void OnEnter();
    public abstract void OnUpdate();
    public abstract void OnExit();
}

// 2. çŠ¶æ€æœºæ§åˆ¶å™¨
public class StateMachine {
    private BaseState _current;
    
    public void ChangeState(BaseState newState) {
        _current?.OnExit();
        _current = newState;
        _current?.OnEnter();
    }
    
    public void Update() {
        _current?.OnUpdate();
    }
}

// 3. å…·ä½“çŠ¶æ€å®ç°
public class BossChaseState : BaseState {
    public override void OnUpdate() {
        if (_boss.DistanceToPlayer < 2.0f) {
            _boss.FSM.ChangeState(_boss.StateAttack); // é¢„å…ˆåˆ›å»ºå¥½çš„å®ä¾‹ï¼Œä¸è¦ new!
        }
    }
}
```

---

## 5. ğŸ“ å®ç”¨å»ºè®®ä¸å‘

### 5.1 ğŸš« é¿å… "Ping-Pong" (çŠ¶æ€ä¹’ä¹“)
*   **ç°è±¡ï¼š** æ€ªç‰©åœ¨ `Move` å’Œ `Attack` ä¹‹é—´ç–¯ç‹‚åˆ‡æ¢ï¼Œæ¯å¸§åˆ‡ä¸€æ¬¡ï¼Œå¯¼è‡´åŠ¨ç”»é¬¼ç•œã€‚
*   **åŸå› ï¼š** æ”»å‡»è·ç¦»åˆ¤å®šå¤ªæ­»ã€‚è¿›å…¥ 5.0m æ”»å‡»ï¼Œé€€å‡º 5.0m ç§»åŠ¨ã€‚
*   **è§£æ³•ï¼š** **è¿Ÿæ» (Hysteresis)**ã€‚
    *   è¿›å…¥æ”»å‡»çŠ¶æ€é˜ˆå€¼ï¼š`Distance < 5.0m`
    *   é€€å‡ºæ”»å‡»çŠ¶æ€é˜ˆå€¼ï¼š`Distance > 6.0m`
    *   ç•™å‡º 1.0m çš„ç¼“å†²åŒºã€‚

### 5.2 ğŸŒ å…¨å±€çŠ¶æ€ (Global State)
*   æœ‰äº›çŠ¶æ€æ˜¯å‡Œé©¾äº FSM ä¹‹ä¸Šçš„ï¼Œæ¯”å¦‚ **CC (æ§åˆ¶)**ã€‚
*   ä¸è¦æŠŠ `Stunned` (çœ©æ™•) åšæˆä¸€ä¸ªæ™®é€šçŠ¶æ€ã€‚
*   **åšæ³•ï¼š** `Stunned` æ˜¯ä¸€ä¸ª **Bool æ ‡è®°**ã€‚åœ¨ `Update()` çš„æœ€å¼€å¤´æ£€æŸ¥ï¼š
    ```csharp
    void Update() {
        if (isStunned) return; // å¦‚æœè¢«æ™•ï¼ŒçŠ¶æ€æœºå®Œå…¨åœè½¬
        FSM.Update();
    }
    ```

### 5.3 ğŸï¸ åŠ¨ç”»çŠ¶æ€æœº (Animator) vs é€»è¾‘çŠ¶æ€æœº (Logic FSM)
*   **åŸåˆ™ï¼š** **Logic FSM é©±åŠ¨ Animatorï¼Œç»åä¹‹ã€‚**
*   **é”™è¯¯ï¼š** åœ¨ Animator çš„ `OnStateExit` é‡Œå†™ä»£ç æ”¹é€»è¾‘å˜é‡ã€‚è¿™ä¼šå¯¼è‡´é€»è¾‘å¾ˆéš¾è°ƒè¯•ã€‚
*   **æ­£ç¡®ï¼š** ä»£ç é‡Œ `ChangeState(Attack)` -> è°ƒç”¨ `animator.SetTrigger("Attack")`ã€‚
