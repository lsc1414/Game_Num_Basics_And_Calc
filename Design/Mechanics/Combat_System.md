# ⚔️ 战斗系统详解 (Combat System Mechanics)

本文档定义了 Project Vampirefall 的核心战斗规则，包括伤害计算流程、属性相互作用、异常状态及控制机制。

---

## 1. 伤害类型与抗性 (Damage Types & Resistances)

为了保证战斗策略的深度，我们采用经典的“三系”分类。

### 1.1 物理 (Physical)
*   **特点:** 基础伤害高，暴击倍率通常较高。
*   **对抗属性:** **护甲 (Armor)**。
*   **穿透:** "Armor Penetration" 属性可忽视部分护甲。

### 1.2 元素 (Elemental)
*   **特点:** 附带异常状态 (Status Effects)，伤害波动较小。
*   **子类型:**
    *   🔥 **火焰 (Fire):** 纯伤害。DoT (持续伤害)。
    *   ❄️ **冰霜 (Cold):** 控制。减速 (Chill) / 冻结 (Freeze)。
    *   ⚡ **雷电 (Lightning):** 群体/爆发。感电 (Shock) 增加受到的伤害。
*   **对抗属性:** **元素抗性 (Elemental Resistance %)**。
    *   抗性上限默认为 75%。

### 1.3 混沌 (Chaos)
*   **特点:** 稀有伤害类型。无视能量护盾 (Energy Shield)。
*   **对抗属性:** **混沌抗性 (Chaos Resistance %)**。
    *   怪物通常混沌抗性较低。

---

## 2. 异常状态 (Status Ailments)

异常状态不仅是视觉效果，更是 Build 构建的核心。

| 状态 | 元素来源 | 触发条件 | 效果详解 | 阈值/公式 |
| :--- | :--- | :--- | :--- | :--- |
| **点燃 (Ignite)** | 🔥 火焰 | 暴击 或 几率 | 4秒内造成 50% 基础点伤/秒。不可叠加，只取最高值。 | 伤害基于单次击中伤害 |
| **冰缓 (Chill)** | ❄️ 冰霜 | 任何冰霜伤害 | 减少 10%~30% 动作速度，持续 2秒。 | 取决于伤害占目标最大HP的比例 |
| **冻结 (Freeze)** | ❄️ 冰霜 | 暴击 或 几率 | 无法行动。持续 0.3s ~ 3s。 | 若冻结时间<0.3s则不触发 |
| **感电 (Shock)** | ⚡ 雷电 | 任何雷电伤害 | 受到的所有伤害增加 10%~50%。持续 2秒。 | 取决于伤害占目标最大HP的比例 |
| **流血 (Bleed)** | ⚔️ 物理 | 技能特定 | 移动时受到额外物理伤害。可叠加 3 层。 | 基础伤害的 30%/秒 |

*注意: 所有异常状态的计算逻辑需遵循 `Design/Numerical_Manual.md` 中的 PRD 随机分布。*

---

## 3. 硬直与韧性 (Stagger & Poise)

为了让打击感“拳拳到肉”，引入韧性系统 (类似于《黑暗之魂》或《只狼》的简化版)。

### 3.1 韧性值 (Poise)
*   所有单位（玩家和怪物）都有一个隐藏的 **Poise HP**。
*   每次受到攻击，扣除等于 `Damage * Impact_Factor` 的韧性值。
*   韧性值会随时间快速恢复 (若 2秒 内未受击)。

### 3.2 硬直状态 (Staggered)
*   当 **Poise <= 0** 时，单位进入 **硬直状态**。
*   **效果:**
    1.  打断当前正在施放的技能/攻击前摇。
    2.  播放受击动画 (Hit Reaction)。
    3.  Poise 瞬间回满，但短时间内 (3秒) 获得的 Poise Damage 减半 (防止无限晕锁)。

### 3.3 击退与击飞 (Knockback & Launch)
*   只有在目标 **Poise 被清零的这一击**，且攻击带有 `Force` 属性时，才会触发击退/击飞。
*   *设计目的:* 防止小技能无限推着 Boss 走。

---

## 4. 仇恨系统 (Aggro System)

由于有塔的存在，怪物的仇恨逻辑比纯 ARPG 复杂。

**优先级列表 (从高到低):**
1.  **嘲讽 (Taunt):** 被嘲讽技能命中，强制攻击施法者 3秒。
2.  **路径阻挡 (Body Block):** 如果无法移动到目标点，攻击阻挡路径的物体（通常是塔或墙）。
3.  **距离 + 伤害权重:** `Score = Damage_Dealt_Last_5s * 2 + (1 / Distance_Squared) * 10`。
    *   这意味着：虽然远程塔在打它，但如果玩家贴脸砍它，它会转头打玩家。

---

## 5. 连击与评分 (Combo & Style)

鼓励进攻的机制。

*   **连击计数:** 3秒内造成伤害不断连。
*   **Combo 阶段:**
    *   *10 Hit:* 移速 +5%。
    *   *50 Hit:* 攻速 +10%，资源获取率 +10%。
    *   *100 Hit (Max):* 全伤害 +20%，并在周围产生电弧。
*   **中断:** 3秒未造成伤害，或受到一次硬直打击 (Stagger)，连击清零。

---

## 6. 吸血与回复 (Leech & Recovery)

为了防止“站撸”，限制回复手段。

*   **生命偷取 (Life Leech):** 不是瞬间回复。
    *   造成伤害的 x% 进入“吸血池”。
    *   吸血池以 `MaxHP * 20% / sec` 的速度回充到生命值。
    *   满血时吸血池清空。
*   **击杀回复 (Life on Kill):** 瞬间回复固定数值。适合割草。
*   **药瓶 (Flask):** 类似 PoE，充能制。杀怪充能，而非冷却制。

---

## 7. 技术实现备注

*   **Tag System:** 使用 `GameplayTag` (如 UE) 或类似的 `Enum Flags` (Unity) 来标记伤害类型 (e.g., `Damage.Fire`, `Damage.Melee`)。
*   **Snapshotting:** DoT 伤害应在施加瞬间计算数值（快照机制），而非随玩家实时面板变化，以减少计算量。
