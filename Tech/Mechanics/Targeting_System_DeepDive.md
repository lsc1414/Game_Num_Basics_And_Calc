# ğŸ¯ ç´¢æ•Œæœºåˆ¶è¯¦è§£ä¸å®æˆ˜ (Targeting System Deep Dive)

æœ¬æ–‡æ¡£åŸºäº [Unified Decision System](../Architecture/Unified_Decision_System.md) æ¶æ„ï¼Œæ·±å…¥è§£æ Project Vampirefall ä¸­çš„ç´¢æ•Œé€»è¾‘ã€‚ç´¢æ•Œï¼ˆTargetingï¼‰æ˜¯å¡”é˜²ä¸ ARPG çš„æ ¸å¿ƒäº¤äº’ä½“éªŒï¼Œå®ƒå†³å®šäº†ç©å®¶æ„Ÿå—åˆ°çš„â€œæ™ºèƒ½â€ç¨‹åº¦ã€‚

---

## 1. æ ¸å¿ƒåŸç†ï¼šä»â€œå¯»æ‰¾â€åˆ°â€œè¯„åˆ†â€ (From Search to Score)

åˆçº§ç´¢æ•Œé€»è¾‘é€šå¸¸æ˜¯ï¼šâ€œæ‰¾åˆ°æœ€è¿‘çš„æ•Œäººâ€ã€‚
ä½†åœ¨æœ¬ä½œä¸­ï¼Œç´¢æ•Œæ˜¯ä¸€ä¸ª **åŠ æƒå†³ç­–è¿‡ç¨‹ (Weighted Decision Process)**ã€‚

### 1.1 æ ‡å‡†æµç¨‹
æ¯ä¸€æ¬¡ç´¢æ•Œè®¡ç®— (`Tick`) éƒ½éµå¾ªä»¥ä¸‹ç®¡é“ï¼š

1.  **åœˆåœ° (Broad Phase):** å¿«é€Ÿè·å–å°„ç¨‹å†…çš„æ‰€æœ‰æ½œåœ¨ç›®æ ‡ï¼ˆåˆ©ç”¨ç©ºé—´åˆ’åˆ†ï¼Œå¦‚ QuadTree æˆ– Physics.OverlapSphereï¼‰ã€‚
2.  **åˆç­› (Filtering):** å‰”é™¤æ— æ•ˆç›®æ ‡ï¼ˆæ— æ•ŒçŠ¶æ€ã€éšèº«çŠ¶æ€ã€å·²æ­»äº¡ã€é˜»æŒ¡è§†çº¿ï¼‰ã€‚
3.  **è¯„åˆ† (Scoring):** å¯¹å‰©ä¸‹çš„æ¯ä¸ªç›®æ ‡è¿è¡Œä¸€ç»„ `Scorer`ï¼Œè®¡ç®—æ€»åˆ†ã€‚
4.  **æ‹©ä¼˜ (Selection):** é€‰å–åˆ†æ•°æœ€é«˜çš„ Top 1 ä½œä¸ºç›®æ ‡ã€‚

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è¯„åˆ†åˆ¶ï¼Ÿ
*   **é˜²å‘†:** é˜²æ­¢ç‹™å‡»å¡”æŠŠé«˜é¢ä¼¤å®³æµªè´¹åœ¨è¿˜æœ‰ 1HP çš„æ‚å…µä¸Šï¼ˆOverkillï¼‰ã€‚
*   **é›†ç«:** è®©ç‰¹å®šçš„å¡”ä¼˜å…ˆæ”»å‡»è¢«â€œç ´ç”²â€æˆ–â€œè¢«æ ‡è®°â€çš„æ•Œäººã€‚
*   **é£æ ¼:** åŒºåˆ†â€œç‹‚æˆ˜å£«â€ï¼ˆæ‰“æœ€è¿‘çš„ï¼‰ä¸â€œåˆºå®¢â€ï¼ˆæ‰“æœ€è„†çš„ï¼‰çš„è¡Œä¸ºæ¨¡å¼ã€‚

---

## 2. è¯„åˆ†ç»´åº¦è¯¦è§£ (Scoring Dimensions)

æˆ‘ä»¬åœ¨ä»£ç ä¸­é€šè¿‡ç»„åˆä¸åŒçš„ `IScorer` æ¥å®ç°å¤æ‚çš„æˆ˜æœ¯é€»è¾‘ã€‚

### ğŸ“ 2.1 è·ç¦»è¯„åˆ† (Distance Scoring)
*   **é€»è¾‘:** è·ç¦»è¶Šè¿‘/è¶Šè¿œï¼Œåˆ†æ•°è¶Šé«˜ã€‚
*   **æ›²çº¿:** å»ºè®®ä½¿ç”¨éçº¿æ€§æ›²çº¿ã€‚
    *   `Score = 1 / Distance` (æåº¦åå¥½è¿‘èº«)
    *   `Score = Distance` (åå¥½è¿œç¨‹ï¼Œå¦‚è¿«å‡»ç‚®æ— æ³•æ”»å‡»è¿‘èº«)
*   **åº”ç”¨:** åŸºç¡€ç®­å¡”ã€è¿‘æˆ˜æ€ªç‰©ã€‚

### ğŸ©¸ 2.2 ç”Ÿå‘½å€¼è¯„åˆ† (Health Scoring)
*   **ä½è¡€é‡ä¼˜å…ˆ (Execute / Cleanup):**
    *   **é€»è¾‘:** `Score = 1 - (CurrentHP / MaxHP)`ã€‚
    *   **ç”¨é€”:** å¿«é€Ÿæ”¶å‰²æ®‹è¡€ï¼Œå‡å°‘åœºä¸Šæ€ªç‰©æ•°é‡ï¼Œè§¦å‘å‡»æ€ç‰¹æ•ˆã€‚
*   **é«˜è¡€é‡ä¼˜å…ˆ (Giant Slayer):**
    *   **é€»è¾‘:** `Score = CurrentHP` æˆ– `Score = CurrentHP / MaxHP`ã€‚
    *   **ç”¨é€”:** ç ´ç”²å¡”ã€ç™¾åˆ†æ¯”ä¼¤å®³æŠ€èƒ½ï¼Œç¡®ä¿é«˜ä¼¤æ‰“åœ¨è‚‰ç›¾ä¸Šã€‚

### ğŸ‘‘ 2.3 ä¼˜å…ˆçº§è¯„åˆ† (Priority Scoring)
*   **é€»è¾‘:** æ ¹æ® `EntityType` ç»™å®šå›ºå®šåˆ†å€¼ã€‚
*   **é…ç½®è¡¨:**
    *   `Boss`: 1000åˆ†
    *   `Elite`: 500åˆ†
    *   `Special (ç‚¸å¼¹äºº)`: 2000åˆ† (ç»å¯¹ä¼˜å…ˆå¤„ç†)
    *   `Minion`: 10åˆ†
*   **ç”¨é€”:** æ‰€æœ‰çš„å¡”éƒ½åº”è¯¥é»˜è®¤å¸¦ä¸€ç‚¹ä¼˜å…ˆçº§ï¼Œé¿å…è¢«å¬å”¤çš„å°æ€ªå¸èµ°ç«åŠ›ã€‚

### ğŸŒªï¸ 2.4 çŠ¶æ€ååŒè¯„åˆ† (Status Synergy Scoring)
*   **é€»è¾‘:** â€œè¶ä½ ç—…è¦ä½ å‘½â€ã€‚å¦‚æœç›®æ ‡èº«ä¸Šæœ‰ç‰¹å®šçš„ Debuffï¼ŒåŠ åˆ†ã€‚
*   **Combo:**
    *   **é›·ç”µå¡”:** å¯¹ `[Soaked]` (æ¹¿æ¶¦) çš„ç›®æ ‡è¯„åˆ† x 2.0ã€‚
    *   **å¤„å†³è€…:** å¯¹ `[Stunned]` (çœ©æ™•) çš„ç›®æ ‡è¯„åˆ† x 3.0ã€‚
*   **ç”¨é€”:** å¼•å¯¼ç©å®¶æ„å»ºå…ƒç´ ååº”é“¾ã€‚

---

## 3. å®æˆ˜æ¡ˆä¾‹ (Use Cases)

ä»¥ä¸‹æ˜¯æ¸¸æˆä¸­å‡ ç§å…¸å‹å•ä½çš„ç´¢æ•Œé…ç½®æ–¹æ¡ˆã€‚

### ğŸ¹ Case A: åŸºç¡€ç®­å¡” (Basic Ballista)
*å®šä½ï¼šæ¸…ç†å†²åˆ°è„¸ä¸Šçš„æ‚å…µï¼Œé˜²æ¼æ€ªã€‚*

| è¯„åˆ†å™¨ | æƒé‡ (Weight) | è¯´æ˜ |
| :--- | :--- | :--- |
| **DistanceScorer** | **3.0** | æåº¦ä¼˜å…ˆæ”»å‡»æœ€è¿‘çš„å•ä½ã€‚ |
| **FixedPriorityScorer** | 0.5 | ç¨å¾®åå¥½ç²¾è‹±æ€ªï¼Œä½†ä¸»è¦è¿˜æ˜¯çœ‹è·ç¦»ã€‚ |
| **HealthScorer (Low)** | 1.0 | ä¼˜å…ˆè¡¥åˆ€æ®‹è¡€ã€‚ |

### ğŸ”« Case B: ç‹™å‡»å¡” (Sniper Turret)
*å®šä½ï¼šé«˜å•å‘ä¼¤å®³ï¼Œææ…¢æ”»é€Ÿã€‚å¿…é¡»é¿å…ä¼¤å®³æº¢å‡ºã€‚*

| è¯„åˆ†å™¨ | æƒé‡ (Weight) | è¯´æ˜ |
| :--- | :--- | :--- |
| **Filter: Overkill** | N/A | **[å…³é”®]** å¦‚æœç›®æ ‡çš„ `HP < å¡”æ”»å‡»åŠ›`ï¼Œç›´æ¥å‰”é™¤ï¼ˆé˜²æ­¢å¤§ç‚®æ‰“èšŠå­ï¼‰ã€‚ |
| **FixedPriorityScorer** | **5.0** | å¿…é¡»ä¼˜å…ˆæ‰“ Boss å’Œ Eliteã€‚ |
| **HealthScorer (High)** | 2.0 | åœ¨åŒçº§æ€ªç‰©ä¸­ï¼Œé€‰è¡€æœ€å¤šçš„æ‰“ã€‚ |
| **DistanceScorer** | -0.5 | ç¨å¾®åå¥½è¿œå¤„çš„ï¼ˆåå‘æƒé‡ï¼‰ï¼Œé¿å…è½¬ç«é¢‘ç¹ã€‚ |

### âš¡ Case C: ç‰¹æ–¯æ‹‰ç”µåœˆ (Tesla Coil)
*å®šä½ï¼šAOE è¿é”æ”»å‡»ï¼Œä¾èµ–å…ƒç´ ååº”ã€‚*

| è¯„åˆ†å™¨ | æƒé‡ (Weight) | è¯´æ˜ |
| :--- | :--- | :--- |
| **TagSynergyScorer** | **4.0** | å¯»æ‰¾å¸¦æœ‰ `[Wet]` æˆ– `[Conductive]` æ ‡ç­¾çš„æ•Œäººã€‚ |
| **ClusterScorer** | 2.0 | **[é«˜çº§]** å¯»æ‰¾å‘¨å›´æ•Œäººæœ€å¯†é›†çš„é‚£ä¸ªç‚¹ä½œä¸ºä¸»ç›®æ ‡ï¼ˆæœ€å¤§åŒ–å¼¹å°„æ”¶ç›Šï¼‰ã€‚ |

### ğŸ‘¹ Case D: åˆºå®¢å‹æ€ªç‰© (Assassin Enemy)
*å®šä½ï¼šåˆ‡åæ’ï¼Œæ¶å¿ƒç©å®¶ã€‚*

| è¯„åˆ†å™¨ | æƒé‡ (Weight) | è¯´æ˜ |
| :--- | :--- | :--- |
| **FixedPriorityScorer** | **10.0** | `Player` > `SupportTower` > `TankTower`ã€‚ |
| **HealthScorer (Low)** | 3.0 | ä¸“æŒ‘è¡€å°‘çš„æ‰“ã€‚ |
| **DistanceScorer** | 0.0 | **æ— è§†è·ç¦»**ã€‚å“ªæ€•è¦ç»•è·¯ï¼Œä¹Ÿè¦å»åˆ‡åæ’ã€‚ |

---

## 4. ä»£ç å®ç°ç‰‡æ®µ (Implementation Snippet)

å¦‚ä½•åœ¨ Unity ä¸­é…ç½®ä¸€ä¸ªâ€œç‹™å‡»å¡”â€çš„å†³ç­–å¼•æ“ï¼š

```csharp
public class SniperTower : MonoBehaviour 
{
    private DecisionEngine<Enemy> _targetingSystem;
    
    void Start() {
        _targetingSystem = new DecisionEngine<Enemy>();
        
        // 1. è¿‡æ»¤ï¼šå¿…é¡»åœ¨å°„ç¨‹å†…ï¼Œä¸”æ´»ç€
        _targetingSystem.AddFilter(new RangeFilter(transform, 50f));
        _targetingSystem.AddFilter(new AliveFilter());
        
        // 2. è¿‡æ»¤ï¼šé˜²æ­¢ä¼¤å®³æº¢å‡º (Overkill Protection)
        // å‡è®¾å¡”æ”»å‡»åŠ›æ˜¯ 500
        _targetingSystem.AddFilter(new MinHealthFilter(500f)); 

        // 3. è¯„åˆ†ï¼šä¼˜å…ˆæ‰“ Boss (æƒé‡æé«˜)
        _targetingSystem.AddScorer(new EntityTypeScorer()
            .SetScore(EntityType.Boss, 1000f)
            .SetScore(EntityType.Elite, 500f));

        // 4. è¯„åˆ†ï¼šä¼˜å…ˆæ‰“æ»¡è¡€çš„ (æƒé‡ä¸­ç­‰)
        _targetingSystem.AddScorer(new HealthScorer(HealthScorerMode.Highest, 10f));
    }

    void Update() {
        if (Time.frameCount % 10 == 0) { // åˆ†å¸§ä¼˜åŒ–
            var enemies = EnemyManager.GetAllEnemies();
            var target = _targetingSystem.SelectBest(enemies, GetContext());
            if (target != null) Fire(target);
        }
    }
}
```

## 5. æ€§èƒ½ä¼˜åŒ–ä¸ç²˜æ€§ (Optimization & Stickiness)

### 5.1 ç›®æ ‡ç²˜æ€§ (Target Stickiness)
ä¸ºäº†é˜²æ­¢å¡”çš„ç‚®å£åœ¨ä¸¤ä¸ªåˆ†æ•°ç›¸è¿‘çš„æ•Œäººä¹‹é—´ç–¯ç‹‚æŠ½æï¼ˆPing-Pongï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥â€œç²˜æ€§â€ã€‚

*   **æœºåˆ¶:** ç»™ `LastTarget` (ä¸Šä¸€æ¬¡é”å®šçš„ç›®æ ‡) ä¸€ä¸ªé¢å¤–çš„åˆ†æ•°åŠ æˆã€‚
*   **å…¬å¼:** `Score += (target == LastTarget) ? StickinessBonus : 0;`
*   **æ•ˆæœ:** é™¤éæ–°ç›®æ ‡çš„å¨èƒå€¼æ˜¾è‘—é«˜äºå½“å‰ç›®æ ‡ï¼ˆä¾‹å¦‚è¶…è¿‡ 20%ï¼‰ï¼Œå¦åˆ™ä¸åˆ‡æ¢ç›®æ ‡ã€‚

### 5.2 ç©ºé—´åˆ’åˆ† (Spatial Partitioning)
åƒä¸‡ä¸è¦éå†å…¨å›¾ `EnemyManager.GetAllEnemies()`ã€‚
*   ä½¿ç”¨ **Grid System** æˆ– **QuadTree**ã€‚
*   å¡”åªè·å–å…¶ `Range` è¦†ç›–çš„ Grid å†…çš„æ•Œäººåˆ—è¡¨ä½œä¸º `Candidates`ã€‚

### 5.3 ååŒç¨‹åº (Coroutines) / Job System
ç´¢æ•Œä¸éœ€è¦æ¯å¸§éƒ½è·‘ã€‚
*   æ¯ 0.1ç§’ ~ 0.2ç§’ æ›´æ–°ä¸€æ¬¡å³å¯ã€‚
*   å¯¹äºå¤§é‡å•ä½ï¼Œä½¿ç”¨ Unity Job System å¹¶è¡Œè®¡ç®—åˆ†æ•°ã€‚

---
